# DemoArigatoの設定手順

以下に、DatabricksのUIを使用してDemoArigatoアプリケーションを設定するための詳細な手順を説明します。各ステップではUIのどこを見て何を設定するかを具体的に示していきます。

## 前提条件の確認

**利用規約への同意**
1. 規約をよく読んで[Google Form](https://forms.gle/BNKA2NErzTxNCvux8)から回答してください。
2. 承認等は行いませんので、回答を以て使用を開始できるものとします。

## 環境設定

### リポジトリのセットアップ
1. サイドバーで「**新規**」をクリック
2. 表示されるメニューから「**Gitフォルダー**」を選択[1][6]
3. リモートリポジトリのURLを入力
4. リポジトリ名と保存先パスを指定
5. 「**作成**」をクリック

### コンピュートの作成

#### SQL Warehouseの設定
1. サイドバーの「**SQL Warehouses**」をクリック[3]
2. 「**SQL Warehouseの作成**」ボタンをクリック
3. 名前を入力（例：「DemoArigato-SQL」）
4. サイズドロップダウンから「**XXS**」を選択
5. 他の設定はデフォルトのままにして「**作成**」をクリック
6. 作成後、SQL WarehouseのIDをメモ（次のセクションのconfig.json設定で必要）

#### MLランタイムクラスターの作成
1. サイドバーの「**コンピュート**」をクリック
2. 「**コンピュートの作成**」ボタンをクリック
3. クラスター名を入力（例：「DemoArigato-Cluster」）
4. 「**シンプル**」フォームが有効になっていることを確認
5. Databricksランタイムのドロップダウンから最新バージョンを選択
6. 「**機械学習**」チェックボックスをオンにしてMLランタイムを選択
7. 「**高度なパフォーマンス**」セクションを展開
8. 「**単一ノード**」チェックボックスをオンにする
9. ノードタイプを選択（60GB以上のメモリを持つタイプ）
10. 「**詳細設定**」セクションを展開
11. アクセスモードで「**手動**」を選択し、ドロップダウンから「**専用**」を選択
12. 「**作成**」をクリックしてクラスターを作成
13. 作成後、クラスターIDをメモ（URLに表示される「?o=xxxxxxxx&clusterId=xxxxxxxx」の部分）

## 設定ファイルの最適化

### config.jsonの設定方法

1. 作成したGitフォルダー内でconfig.jsonファイルを開くか作成
2. 以下のパラメータを編集：

```json
{
  "SERVER_HOSTNAME": "sample-workspace.cloud.databricks.com",
  "DATABRICKS_HOST": "https://sample-workspace.cloud.databricks.com/",
  "ENDPOINT_NAME": "databricks-claude-3-7-sonnet",
  "CATALOG": "example_catalog",
  "SCHEMA": "test_schema",
  "WAREHOUSE_ID": "a1b2c3d4e5f6g7h8",
  "CLUSTER_ID": "1234-567890-abcdef",
  "USER_NAME": "example.user@company.com",
  "ROOT_DIR": "/Workspace/Users/example.user@company.com/demoarigato"
}
```

#### 各パラメータの確認方法

- **SERVER_HOSTNAME**：
  1. ブラウザのアドレスバーを確認
  2. 「https://」の後、「/」の前の部分をコピー（例：`sample-workspace.cloud.databricks.com`）

- **DATABRICKS_HOST**：
  1. ブラウザのアドレスバーのURLをコピー
  2. 末尾に「/」があることを確認（例：`https://sample-workspace.cloud.databricks.com/`）

- **ENDPOINT_NAME**：
  1. サイドバーの「**Machine Learning**」をクリック
  2. 「**モデルサービング**」タブを選択
  3. 使用するエンドポイントの名前をコピー
  4. 「databricks-claude-3-7-sonnet」の使用を強く推奨します

- **CATALOG**と**SCHEMA**：
  1. サイドバーの「**Data**」をクリック
  2. カタログエクスプローラーでカタログとスキーマを確認
  3. 使用するカタログとスキーマの名前をコピー

- **WAREHOUSE_ID**：
  1. 「**SQL Warehouses**」で作成したウェアハウスをクリック
  2. ブラウザのURLを確認し、「warehouseId=」の後の文字列をコピー
  3. または、ウェアハウスの概要ページの「ID」表示から確認

- **CLUSTER_ID**：
  1. 「**コンピュート**」から作成したクラスターをクリック
  2. ブラウザのURLから「clusterId=」の後の文字列をコピー

- **USER_NAME**：
  1. 画面右上のユーザープロファイルアイコンをクリック
  2. 表示されるユーザーメールアドレスをコピー

- **ROOT_DIR**：
  1. ワークスペースでDemoArigatoのGitフォルダーのパスを指定
  2. 通常は `/Workspace/Users/あなたのメールアドレス/demoarigato` 形式

## アプリケーションのデプロイ

### Databricks Appsの作成
1. サイドバーの「**新規**」をクリック
2. メニューから「**アプリ**」を選択
3. 「**カスタム**」オプションを選択
4. アプリ名に「DemoArigato」を入力
5. 必要に応じて説明を追加
6. 「**アプリの作成**」ボタンをクリック
7. アプリの詳細ページで指示に従い、作成したGitフォルダーのコードをアプリに同期

### 権限設定
1. **Appsのサービスプリンシパルを確認**：
   - アプリの詳細ページで、サービスプリンシパル情報を確認

2. **SQL Warehouseに権限を付与**：
   - 「**SQL Warehouses**」に移動
   - 作成したウェアハウスの「**権限**」タブをクリック
   - 「**追加**」をクリックしてAppsのサービスプリンシパルを検索
   - 「**USE**」権限を付与

3. **クラスターに権限を付与**：
   - 「**コンピュート**」に移動
   - 作成したクラスターの「**権限**」タブをクリック
   - 「**追加**」をクリックしてAppsのサービスプリンシパルを検索
   - シングルユーザーアクセスリストにサービスプリンシパルを追加

### アクセス管理
1. サイドバーの「**アプリ**」をクリック
2. 作成した「DemoArigato」アプリをクリック
3. 「**権限**」タブをクリック
4. 「**追加**」をクリックして適切なユーザーやグループを検索
5. 「**Can Use**」権限を付与
6. アプリのURLをユーザーと共有（アプリの詳細ページからコピー可能）

以上の手順に従うことで、DemoArigatoアプリケーションがDatabricks環境に正しく設定され、動作するようになります。設定に問題がある場合は、各ステップでのエラーメッセージを確認し、適宜調整してください。
